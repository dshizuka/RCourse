---
title: "Data Wrangling to plots with tidyverse packages"
author: "Dai Shizuka"
date: "updated `r format(Sys.time(), '%m/%d/%y')` "
output: 
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
---

## 1. Intro to the ['tidyverse'](https://www.tidyverse.org/)

```{r, out.width="10%", echo=F}
knitr::include_graphics("images/icons/tidyr.png")
knitr::include_graphics("images/icons/dplyr.png")
knitr::include_graphics("images/icons/stringr.png")
knitr::include_graphics("images/icons/ggplot2.png")
```

Now that we have dipped our feet into plots and stats in R, I think you are getting a better sense of the fact that 'wrangling' or 'manipulating' data is one of the biggest steps to becoming proficient in R and all that it has to offer. 

For example, for any given analysis, you may have to subset data, filter out certain data that don't meet some criteria, focus in on a select set of variables of interest, calculate means, and variance for different groups, etc. etc. 

These tasks are where the packages [dplyr](https://dplyr.tidyverse.org/), [tidyr](https://tidyr.tidyverse.org/) and other packages in the [tidyverse](https://www.tidyverse.org/)--a series of packages designed for all kinds of data tasks. This also includes the popular [ggplot2](https://ggplot2.tidyverse.org/) package for graphics. 

The tidyverse packages are constructed by [Hadley Wickam](http://hadley.nz/). There are several books that cover how to use these packages, including *R for Data Science* [which is available for free as an online book](https://r4ds.had.co.nz/)

```{r, out.width="20%", echo=F}
knitr::include_graphics("images/icons/R_for_Data_Science_cover.png")
```

In this module, we'll be learning some functions from the packages **dplyr** and **tidyr**. 

><span style="color:purple">***What is a "package" in R?***</span>
>
>R packages are essentially a set of custom functions that R users have created and compiled, along with help files and vignettes, etc. Many of them are archived at CRAN--The Comprehensive R Archive Network--and available to install from the R console using the function `install.packages()`. There are still many other packages that users have not archived but are available from other sources, such as github. "Installing" the package means that the package is downloaded onto your computer. When you are ready to use them, you will have to load the package onto the environment by running the function `library()` or `require()`. 



***


## 2. Installing and loading the package

<br>

### 2.1 Installing tidyverse packages (and packages in general)

One can install each package separately, but you can also just install all "tidyverse" packages simply by running this command:

```{r, eval=FALSE}
install.packages("tidyverse")
```

Note that this simply downloads the packages onto your computer. When you are ready to use them, you will have to load the package onto the environment by running the function

### 2.2 Loading the package

You now have the package downloaded on your computer, but to actually use it, you have to load the package. We can load the entire `tidyverse` package (or, if you prefer, you can just load the `tidyr` package).

```{r}
library(tidyverse)
```

**Two important thing to notice here.** First, the message tells you what packages were actually loaded as part of the tidyverse "metapackage". You see that this includes 8 packages: ggplot2,tibble, tidyr, readr, purrr, dplyr, stringr, and forcats. Second, the message tells you that there are two functions in the `dplyr` package that conflict with existing functions: `filter()` and `lag()`. This is sometimes very important to know! This means that the `filter()` function works differently before and after loading this package.

### 2.3. Getting the package documentation

When I'm first learning a package, I often start by pulling up the documentation for it. You can do this by running `library(help="packagename")`.

Let's do this with the `tidyr` package:

```{r}
library(help="tidyr")
```

A new tab will open in the script editor window with the text documentation of the package, which includes info like version, authors, brief description, the homepage url, etc. Then, you will see the "index" section, which will list *all of the functions and other objects that are included in this package*. 

You can learn about each function or object by using `?` in front of the name. Try it out:

```{r}
?replace_na
?pivot_longer

?billboard
?relig_income
```

In this case, you will see that the package includes not only functions, but also sample datasets (`billboard` and `relig_income` being two of them). Get used to pulling up the documentation whenever you are learning to use a new package!

***

><span style="color:purple">***Some things to know about getting started with 'tidyverse'***</span>
>
>**Pipe Operator (`%>%`):**
>tidyverse makes use of the pipe operator `%>%`, which allows you to carry over the output of one function to the next function. This can make series of data manipulation sequences much more efficient. 
>
>**Tibbles:**
>"tibble" is a special class of dataframe that is used in tidyverse. It is largely the same as a dataframe but it has some features (or rather, lack of features) that make for 'defensive coding'. That is, it forces you to avoid dangerous operations, such as changing variable names or types (you have to explicitly do this) or allow "partial matching".
>
>To learn more about tibbles, start [here](https://tibble.tidyverse.org/)


***

## Dealing with complex data

World Bank Population Data up to 2017 (version included in tidyr package):

```{r}
head(world_bank_pop)
```
First, restrict the data to countries with large populations--let's say those above 75 percentile in population size over 2020-2017

```{r}
upper.pop=world_bank_pop %>% dplyr::filter(indicator == "SP.POP.TOTL") %>% pull(`2017`) 
```

```{r}
#calculate average population size for all countries
upper.pop=world_bank_pop %>% dplyr::filter(indicator == "SP.POP.TOTL") %>% pull(`2017`) %>% quantile(., probs=0.9, na.rm=T)
upper.pop

upper.countries=world_bank_pop %>% dplyr::filter(indicator == "SP.POP.TOTL") %>% dplyr::filter(`2017` > upper.pop) %>% select(country)
```

Just get the population growth rate data using `dplyr::filter()`

```{r}
left_join(upper.countries, world_bank_pop) %>% dplyr::filter(indicator=="SP.POP.GROW")
```

Convert this data to "long-format"

```{r}
left_join(upper.countries, world_bank_pop) %>% dplyr::filter(indicator=="SP.POP.GROW") %>% pivot_longer(-c(country,indicator), names_to="year")
```
Clean up and save as an object

```{r}
df=left_join(upper.countries, world_bank_pop) %>% dplyr::filter(indicator=="SP.POP.GROW") %>% pivot_longer(-c(country,indicator), names_to="year") %>% select(-indicator) %>% mutate(pop.growth=value, .keep="unused") %>% mutate(year=as.numeric(year))
df
```

```{r}
ggplot(df, aes(x=year, y=pop.growth, color=country)) +
  geom_line()
```

```{r}

pop=world_bank_pop %>% pivot_longer(-c(country,indicator), names_to="year") %>% mutate(year=as.numeric(year)) %>% dplyr::filter(country=="CAN" | country=="USA" | country=="MEX") %>% dplyr::filter(indicator=="SP.POP.GROW") %>% mutate(pop.growth=value)


ggplot(pop, aes(x=year, y=pop.growth, color=country)) + 
  geom_line() +
  theme_classic() +
  geom_hline(aes(yintercept=1), linetype=2) +
  ylab("Population Growth Rate") +
  xlab("Year")


d1=world_bank_pop %>% dplyr::filter(indicator=="SP.URB.TOTL" | indicator=="SP.POP.TOTL") %>%
  select(country, indicator, `2017`) %>%
  pivot_wider(., id_cols=country, names_from=indicator, values_from=`2017`)

ggplot(d1, aes(x=SP.POP.TOTL, y=SP.URB.TOTL)) +
  geom_point() +
  scale_x_continuous(trans="log") +
  scale_y_continuous(trans="log") +
  xlab("Total Population Size") +
  ylab("Urban Population Size") +
  theme_bw()

```



## 3. Using `tidyr` to reshape data



## 4. Working with `dplyr`

<br>

### 3.1 Main `dplyr` functions

* `select()` select columns by criteria
* `filter()` filter rows by criteria
* `mutate()`: add new variable using functions
* `summarise()`: calculate summary statistic for a given variable
* `arrange()`: change order of rows
* `group_by()`: run any of above function 'by group' defined using criteria

<br>


