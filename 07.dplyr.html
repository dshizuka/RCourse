<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Dai Shizuka" />


<title>Module 7: Data Wrangling with dplyr</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/sandstone.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 61px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 66px;
  margin-top: -66px;
}
.section h2 {
  padding-top: 66px;
  margin-top: -66px;
}
.section h3 {
  padding-top: 66px;
  margin-top: -66px;
}
.section h4 {
  padding-top: 66px;
  margin-top: -66px;
}
.section h5 {
  padding-top: 66px;
  margin-top: -66px;
}
.section h6 {
  padding-top: 66px;
  margin-top: -66px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Intro to R</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="syllabus.html">Syllabus</a>
</li>
<li>
  <a href="modules.html">Modules</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Module 7: Data Wrangling with dplyr</h1>
<h4 class="author">Dai Shizuka</h4>
<h4 class="date">updated 09/24/19</h4>

</div>


<div id="intro-to-dplyr-and-the-tidyverse" class="section level2">
<h2>1. Intro to <code>dplyr</code> and the ‘tidyverse’</h2>
<p><img src="images/hex-dplyr.png" width="10%" /><img src="images/hex-tidyr.png" width="10%" /></p>
<p>Now that we have dipped our feet into plots and stats in R, I think you are getting a better sense of the fact that ‘wrangling’ or ‘manipulating’ data is one of the biggest steps to becoming proficient in R and all that it has to offer.</p>
<p>For example, for any given analysis, you may have to subset data, filter out certain data that don’t meet some criteria, focus in on a select set of variables of interest, calculate means, and variance for different groups, etc. etc.</p>
<p>These tasks are where the packages <a href="https://dplyr.tidyverse.org/">dplyr</a>, <a href="https://tidyr.tidyverse.org/">tidyr</a> and other packages in the <a href="https://www.tidyverse.org/">tidyverse</a>–a series of packages designed for all kinds of data tasks. This also includes the popular <a href="https://ggplot2.tidyverse.org/">ggplot2</a> package for graphics.</p>
<p>The tidyverse packages are constructed by <a href="http://hadley.nz/">Hadley Wickam</a>. There are several books that cover how to use these packages, including <em>R for Data Science</em> <a href="https://r4ds.had.co.nz/">which is available for free as an online book</a></p>
<p><img src="images/R_for_Data_Science_cover.png" width="20%" /></p>
<hr />
</div>
<div id="working-with-dplyr" class="section level2">
<h2>2. Working with <code>dplyr</code></h2>
<p><br></p>
<div id="main-dplyr-functions" class="section level3">
<h3>2.1 Main <code>dplyr</code> functions</h3>
<ul>
<li><code>select()</code> select columns by criteria</li>
<li><code>filter()</code> filter rows by criteria</li>
<li><code>mutate()</code>: add new variable using functions</li>
<li><code>summarise()</code>: calculate summary statistic for a given variable</li>
<li><code>arrange()</code>: change order of rows</li>
<li><code>group_by()</code>: run any of above function ‘by group’ defined using criteria</li>
</ul>
<p><br></p>
</div>
<div id="pipe-operator" class="section level3">
<h3>2.2 Pipe Operator (<code>%&gt;%</code>)</h3>
<p><code>dplyr</code> makes use of the pipe operator <code>%&gt;%</code>, which allows you to carry over the output of one function to the next function. This can make series of data manipulation sequences much more efficient.</p>
<p><br></p>
</div>
<div id="tibble" class="section level3">
<h3>2.3 Tibble</h3>
<p>The output of <code>dplyr</code> functions is a “tibble”, a special class of data frame. It is largely the same as a data.frame but it has some features (or rather, lack of features) that make for ‘defensive coding’. That is, it forces you to avoid dangerous operations, such as changing variable names or types (you have to explicitly do this) or allow “partial matching”.</p>
<p>To learn more about tibbles, start <a href="https://tibble.tidyverse.org/">here</a></p>
<ul>
<li>tibble</li>
<li>functions that have special syntax – but once you learn them, it’s hard to go back.</li>
</ul>
<hr />
</div>
</div>
<div id="an-example-using-data-on-chick-color-of-american-coots" class="section level2">
<h2>3. An example using data on chick color of American coots</h2>
<p>To demonstrate how <code>dplyr</code> functions work, we will use a dataset from a project on color variation in American coots (<em>Fulica americana</em>), a waterbird of the Rail family. Coots lay a relatively large number of eggs (6-12 eggs) in nests built out of old vegetation on top of water in wetlands across western North America.</p>
<p>There are at least two very weird thing about coots: One weird thing is that they are ‘conspecific brood parasites’–i.e., they make their own nests, but they will also opportunistically lay eggs in their neighboring coot nests. Our research has shown that they can, under certain circumstances, tell which eggs and chicks in their nest are parasitic (Lyon 2003; Shizuka &amp; Lyon 2010).</p>
<p>The other very weird thing is that they have <strong>extremely bright ornamental juvenile traits (red beaks, red head, orange plumes around the neck, etc.)</strong> when they hatch. They then lose these traits over the first few weeks of life. By the time they have fledged, they are black and gray with white beaks, and the only color they retain is a small patch or red on their forehead. Birds commonly have bright ornamental traits related to sexual selection, but it is relatively rare to have such bright ornaments as babies (probably because it could make them easy targets for predators).</p>
<p><img src="images/CootFeeding_lowres.jpg" width="40%" /><img src="images/cootnest.jpg" width="40%" /></p>
<p>Past work (Lyon et al. 1994) has shown that, if you artificially remove some of these ornaments (i.e., the orange tips of feathers around neck), parents discriminate against these ‘dull’ chicks and preferentially feed chicks that retain the ornaments.</p>
<p>In the present work (NOTE: <em>this is unpublished data (under review)</em>), we investigate the causes and consequences of variation in color (i.e., how ‘red’ the chicks are) within and between broods. To do this, we monitored nests and eggs until hatching, and then measured color of juvenile ornaments using a spectrometer (which measures reflectance of light at different wavelengths) from ~1,500 chicks. We have condensed data to several key color metrics, including the ‘red chroma’ (i.e., amount of light reflected at the red wavelengths: approx 600-700nm) of the feathers around the chin. We combine this data with various other measures for each chick, including the order in which they were laid as eggs, the size of egg, and the order in which they hatched.</p>
<p>Here is the <a href="data/chickcolor_Rclass.csv">link to data</a>. Save this in your course folder in the “data” subfolder.</p>
<p>Then import this data to R:</p>
<pre class="r"><code>dat=read.csv(&quot;data/chickcolor_Rclass.csv&quot;)
head(dat)</code></pre>
<pre><code>##   chick.id nest year egg.id is.parasite hatch.order  egg.vol egg.seq
## 1   5001-1 5001 2005      1       FALSE           1 30.88715     1.5
## 2  5001-10 5001 2005     10       FALSE           5 31.24612    10.0
## 3  5001-11 5001 2005     11       FALSE           6 31.48034    11.0
## 4  5001-12 5001 2005     12       FALSE           7 28.71836    12.0
## 5   5001-2 5001 2005      2       FALSE           2 34.48371     1.5
## 6   5001-3 5001 2005      3       FALSE           1 35.03021     3.0
##   chin_chroma
## 1   0.6659823
## 2   0.7001972
## 3   0.7429716
## 4   0.6928042
## 5   0.6054178
## 6   0.6780352</code></pre>
<p>Let’s also load the entire <code>tidyverse</code> series of packages</p>
<pre class="r"><code>library(&#39;tidyverse&#39;)</code></pre>
<pre><code>## ── Attaching packages ─────────────────────────────────────────────────────────────────────────── tidyverse 1.2.1 ──</code></pre>
<pre><code>## ✔ ggplot2 3.2.1     ✔ purrr   0.3.2
## ✔ tibble  2.1.3     ✔ dplyr   0.8.3
## ✔ tidyr   1.0.0     ✔ stringr 1.4.0
## ✔ readr   1.3.1     ✔ forcats 0.4.0</code></pre>
<pre><code>## ── Conflicts ────────────────────────────────────────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()</code></pre>
<div id="task-1-filter-out-parasite-chicks-and-then-calculate-mean-chick-color-for-each-brood" class="section level3">
<h3>task 1: filter out parasite chicks and then calculate mean chick color for each brood</h3>
<pre class="r"><code>#old way
dat.a=dat
dat.b=dat.a[which(dat.a$is.parasite==F),]
dat.c=aggregate(dat.b$chin_chroma, by=list(dat.b$nest), mean, na.rm=T)
names(dat.c)=c(&quot;nest&quot;, &quot;mean.col&quot;)
head(dat.c)</code></pre>
<pre><code>##   nest  mean.col
## 1 5001 0.6916427
## 2 5002 0.6908938
## 3 5003 0.6886885
## 4 5004 0.6974353
## 5 5005 0.7064812
## 6 5007 0.6844351</code></pre>
<pre class="r"><code>#dplyr way, option 1
x=filter(dat.a, is.parasite==FALSE)
y=group_by(x, nest)
z=summarise(y, mean(chin_chroma))
z</code></pre>
<pre><code>## # A tibble: 305 x 2
##     nest `mean(chin_chroma)`
##    &lt;int&gt;               &lt;dbl&gt;
##  1  5001               0.692
##  2  5002               0.691
##  3  5003               0.689
##  4  5004               0.697
##  5  5005               0.706
##  6  5007               0.684
##  7  5008               0.717
##  8  5009               0.697
##  9  5010               0.723
## 10  5011               0.722
## # … with 295 more rows</code></pre>
<pre class="r"><code>#dplyr way, with piping
dat %&gt;% filter(is.parasite==FALSE) %&gt;% group_by(nest) %&gt;% summarise(mean.col=mean(chin_chroma))</code></pre>
<pre><code>## # A tibble: 305 x 2
##     nest mean.col
##    &lt;int&gt;    &lt;dbl&gt;
##  1  5001    0.692
##  2  5002    0.691
##  3  5003    0.689
##  4  5004    0.697
##  5  5005    0.706
##  6  5007    0.684
##  7  5008    0.717
##  8  5009    0.697
##  9  5010    0.723
## 10  5011    0.722
## # … with 295 more rows</code></pre>
</div>
<div id="task-2-standardize-each-chicks-color-measure-against-average-of-its-nest." class="section level3">
<h3>task 2: standardize each chick’s color measure against average of its nest.</h3>
<pre class="r"><code>#old way
dat.a$nest.mean.col=dat.c[match(dat.a$nest, dat.c$nest), 2]
dat.a$std.col=dat.a$chin_chroma-dat.a$nest.mean.col
head(dat.a)</code></pre>
<pre><code>##   chick.id nest year egg.id is.parasite hatch.order  egg.vol egg.seq
## 1   5001-1 5001 2005      1       FALSE           1 30.88715     1.5
## 2  5001-10 5001 2005     10       FALSE           5 31.24612    10.0
## 3  5001-11 5001 2005     11       FALSE           6 31.48034    11.0
## 4  5001-12 5001 2005     12       FALSE           7 28.71836    12.0
## 5   5001-2 5001 2005      2       FALSE           2 34.48371     1.5
## 6   5001-3 5001 2005      3       FALSE           1 35.03021     3.0
##   chin_chroma nest.mean.col      std.col
## 1   0.6659823     0.6916427 -0.025660365
## 2   0.7001972     0.6916427  0.008554481
## 3   0.7429716     0.6916427  0.051328960
## 4   0.6928042     0.6916427  0.001161534
## 5   0.6054178     0.6916427 -0.086224901
## 6   0.6780352     0.6916427 -0.013607519</code></pre>
<pre class="r"><code>#with merge()
dat.merge=merge(dat.a, dat.c, by=&quot;nest&quot;)
head(dat.merge)</code></pre>
<pre><code>##   nest chick.id year egg.id is.parasite hatch.order  egg.vol egg.seq
## 1 5001  5001-11 2005     11       FALSE           6 31.48034    11.0
## 2 5001   5001-1 2005      1       FALSE           1 30.88715     1.5
## 3 5001   5001-4 2005      4       FALSE           2 32.17131     4.0
## 4 5001   5001-6 2005      6       FALSE           2 33.62230     6.0
## 5 5001  5001-10 2005     10       FALSE           5 31.24612    10.0
## 6 5001   5001-3 2005      3       FALSE           1 35.03021     3.0
##   chin_chroma nest.mean.col      std.col  mean.col
## 1   0.7429716     0.6916427  0.051328960 0.6916427
## 2   0.6659823     0.6916427 -0.025660365 0.6916427
## 3   0.6415362     0.6916427 -0.050106528 0.6916427
## 4   0.7193327     0.6916427  0.027689999 0.6916427
## 5   0.7001972     0.6916427  0.008554481 0.6916427
## 6   0.6780352     0.6916427 -0.013607519 0.6916427</code></pre>
<pre class="r"><code>#with dyplr
dat.a=left_join(dat.a, dat.c, by=&quot;nest&quot;) %&gt;% mutate(std.chick.col=chin_chroma-mean.col)
head(dat.a)</code></pre>
<pre><code>##   chick.id nest year egg.id is.parasite hatch.order  egg.vol egg.seq
## 1   5001-1 5001 2005      1       FALSE           1 30.88715     1.5
## 2  5001-10 5001 2005     10       FALSE           5 31.24612    10.0
## 3  5001-11 5001 2005     11       FALSE           6 31.48034    11.0
## 4  5001-12 5001 2005     12       FALSE           7 28.71836    12.0
## 5   5001-2 5001 2005      2       FALSE           2 34.48371     1.5
## 6   5001-3 5001 2005      3       FALSE           1 35.03021     3.0
##   chin_chroma nest.mean.col      std.col  mean.col std.chick.col
## 1   0.6659823     0.6916427 -0.025660365 0.6916427  -0.025660365
## 2   0.7001972     0.6916427  0.008554481 0.6916427   0.008554481
## 3   0.7429716     0.6916427  0.051328960 0.6916427   0.051328960
## 4   0.6928042     0.6916427  0.001161534 0.6916427   0.001161534
## 5   0.6054178     0.6916427 -0.086224901 0.6916427  -0.086224901
## 6   0.6780352     0.6916427 -0.013607519 0.6916427  -0.013607519</code></pre>
<div id="section" class="section level5">
<h5></h5>
</div>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
